# üîí H∆∞·ªõng D·∫´n B·∫£o M·∫≠t - KTV Admin

## üìã M·ª•c L·ª•c
1. [T·ªïng Quan](#t·ªïng-quan)
2. [C√°c C·∫£i Ti·∫øn ƒê√£ Th·ª±c Hi·ªán](#c√°c-c·∫£i-ti·∫øn-ƒë√£-th·ª±c-hi·ªán)
3. [C·∫•u H√¨nh B·∫£o M·∫≠t](#c·∫•u-h√¨nh-b·∫£o-m·∫≠t)
4. [S·ª≠ D·ª•ng Security Utilities](#s·ª≠-d·ª•ng-security-utilities)
5. [Best Practices](#best-practices)
6. [Checklist B·∫£o M·∫≠t](#checklist-b·∫£o-m·∫≠t)
7. [X·ª≠ L√Ω S·ª± C·ªë](#x·ª≠-l√Ω-s·ª±-c·ªë)

---

## T·ªïng Quan

D·ª± √°n ƒë√£ ƒë∆∞·ª£c c·∫£i thi·ªán v·ªõi c√°c t√≠nh nƒÉng b·∫£o m·∫≠t to√†n di·ªán ƒë·ªÉ b·∫£o v·ªá kh·ªèi c√°c m·ªëi ƒëe d·ªça ph·ªï bi·∫øn nh∆∞:

- ‚úÖ XSS (Cross-Site Scripting)
- ‚úÖ CSRF (Cross-Site Request Forgery)
- ‚úÖ SQL Injection
- ‚úÖ Brute Force Attacks
- ‚úÖ Rate Limiting / DDoS
- ‚úÖ Clickjacking
- ‚úÖ Open Redirects
- ‚úÖ Path Traversal
- ‚úÖ Session Hijacking
- ‚úÖ Data Leaks

---

## C√°c C·∫£i Ti·∫øn ƒê√£ Th·ª±c Hi·ªán

### 1. üõ°Ô∏è Security Headers (next.config.ts)

**Tr∆∞·ªõc:**
```typescript
typescript: {
  ignoreBuildErrors: true, // ‚ùå NGUY HI·ªÇM!
},
```

**Sau:**
```typescript
typescript: {
  ignoreBuildErrors: false, // ‚úÖ An to√†n
},
```

**Headers ƒë√£ th√™m:**
- `X-Frame-Options: SAMEORIGIN` - NgƒÉn clickjacking
- `X-Content-Type-Options: nosniff` - NgƒÉn MIME sniffing
- `X-XSS-Protection: 1; mode=block` - B·∫≠t XSS filter
- `Strict-Transport-Security` - Force HTTPS
- `Content-Security-Policy` - Ki·ªÉm so√°t t√†i nguy√™n
- `Referrer-Policy` - Ki·ªÉm so√°t referrer
- `Permissions-Policy` - Gi·ªõi h·∫°n API browser

### 2. üö¶ Rate Limiting

T·∫°o `src/lib/security/rate-limit.ts`:
- **Auth endpoints**: 5 attempts / 15 ph√∫t
- **API endpoints**: 60 requests / ph√∫t
- **Strict endpoints**: 10 requests / ph√∫t

### 3. ‚úîÔ∏è Input Validation & Sanitization

T·∫°o `src/lib/security/validation.ts`:
- Sanitize HTML (ngƒÉn XSS)
- Validate email, password, phone
- Check XSS patterns
- Sanitize filenames, URLs
- Validate UUID, slugs

### 4. üîê Encryption & Hashing

T·∫°o `src/lib/security/encryption.ts`:
- AES-256-GCM encryption
- Password hashing v·ªõi PBKDF2
- Secure token generation
- Data masking (email, phone, card)

### 5. üõ°Ô∏è CSRF Protection

T·∫°o `src/lib/security/csrf.ts`:
- Generate CSRF tokens
- Validate tokens v·ªõi timing-safe comparison
- HttpOnly cookies

### 6. üîë Authentication Security

T·∫°o `src/lib/security/auth-helpers.ts`:
- Role-based access control
- Account lockout (5 failed attempts)
- Password strength validation
- Session management

### 7. üåê Security Headers Utilities

T·∫°o `src/lib/security/headers.ts`:
- Dynamic security headers
- CORS configuration
- CSP (Content Security Policy)
- Cache control headers

### 8. üõ†Ô∏è Middleware Helpers

T·∫°o `src/lib/security/middleware-helpers.ts`:
- Client identification (IP)
- Suspicious pattern detection
- Request validation
- Security event logging

---

## C·∫•u H√¨nh B·∫£o M·∫≠t

### 1. Environment Variables

Copy file `env.example` th√†nh `.env.local`:

```bash
cp env.example .env.local
```

**C√°c bi·∫øn quan tr·ªçng:**

```env
# Supabase (B·∫ÆT BU·ªòC)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-key # ‚ö†Ô∏è KEEP SECRET

# Security (KHUY·∫æN NGH·ªä)
ENCRYPTION_SECRET=your-32-char-secret
SESSION_SECRET=your-session-secret
```

**Generate secrets:**
```bash
# Linux/Mac
openssl rand -hex 32

# Windows PowerShell
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))
```

### 2. Supabase Row Level Security (RLS)

**QUAN TR·ªåNG:** B·∫≠t RLS cho t·∫•t c·∫£ c√°c tables:

```sql
-- Enable RLS
ALTER TABLE ktvs ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE images ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- Policy cho users table
CREATE POLICY "Users can view own data"
  ON users FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Admins can view all users"
  ON users FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- Policy cho ktvs table
CREATE POLICY "Public can view active KTVs"
  ON ktvs FOR SELECT
  USING (is_active = true);

CREATE POLICY "Authenticated users can manage own KTVs"
  ON ktvs FOR ALL
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can manage all KTVs"
  ON ktvs FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

### 3. Vercel Deployment Security

Khi deploy l√™n Vercel:

1. **Environment Variables:**
   - Th√™m t·∫•t c·∫£ vars t·ª´ `env.example`
   - ƒê·∫£m b·∫£o `SUPABASE_SERVICE_ROLE_KEY` ch·ªâ c√≥ ·ªü Production/Preview

2. **Domains:**
   - Th√™m domain v√†o `NEXT_PUBLIC_BASE_URL`
   - C·∫≠p nh·∫≠t CORS allowed origins

3. **Headers:**
   ```json
   {
     "headers": [
       {
         "source": "/(.*)",
         "headers": [
           {
             "key": "X-Frame-Options",
             "value": "SAMEORIGIN"
           }
         ]
       }
     ]
   }
   ```

---

## S·ª≠ D·ª•ng Security Utilities

### 1. Rate Limiting trong API Routes

```typescript
// app/api/login/route.ts
import { authRateLimiter } from '@/lib/security/rate-limit';

export async function POST(request: Request) {
  // Get client IP
  const ip = request.headers.get('x-forwarded-for') || 'unknown';
  
  // Check rate limit
  const { success, remaining } = authRateLimiter.check(ip);
  
  if (!success) {
    return Response.json(
      { error: 'Too many login attempts' },
      { status: 429 }
    );
  }
  
  // Continue with login logic...
}
```

### 2. Input Validation

```typescript
import { 
  sanitizeHtml, 
  isValidEmail, 
  validatePassword 
} from '@/lib/security/validation';

// Sanitize user input
const safeName = sanitizeHtml(userInput);

// Validate email
if (!isValidEmail(email)) {
  return { error: 'Invalid email format' };
}

// Check password strength
const { isValid, errors } = validatePassword(password);
if (!isValid) {
  return { error: errors.join(', ') };
}
```

### 3. CSRF Protection

```typescript
// Server Component
import { setCsrfToken, getCsrfToken } from '@/lib/security/csrf';

export default async function FormPage() {
  const token = await setCsrfToken();
  
  return (
    <form>
      <input type="hidden" name="csrf_token" value={token} />
      {/* other fields */}
    </form>
  );
}

// API Route
import { verifyCsrfToken } from '@/lib/security/csrf';

export async function POST(request: Request) {
  const formData = await request.formData();
  const token = formData.get('csrf_token') as string;
  
  if (!await verifyCsrfToken(token)) {
    return Response.json({ error: 'Invalid CSRF token' }, { status: 403 });
  }
  
  // Continue...
}
```

### 4. Authentication Guards

```typescript
import { requireAuth, requireAdmin } from '@/lib/security/auth-helpers';

// Require any authenticated user
export async function GET() {
  try {
    const user = await requireAuth();
    // User is authenticated
  } catch (error) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }
}

// Require admin
export async function DELETE() {
  try {
    const admin = await requireAdmin();
    // User is admin
  } catch (error) {
    return Response.json({ error: 'Forbidden' }, { status: 403 });
  }
}
```

### 5. Encryption

```typescript
import { encrypt, decrypt, maskEmail } from '@/lib/security/encryption';

// Encrypt sensitive data
const encrypted = encrypt('sensitive data', process.env.ENCRYPTION_SECRET!);

// Decrypt
const decrypted = decrypt(encrypted, process.env.ENCRYPTION_SECRET!);

// Mask email for display
const masked = maskEmail('user@example.com'); // "use***@example.com"
```

### 6. Failed Login Tracking

```typescript
import { 
  recordFailedLogin, 
  clearFailedLogins,
  isAccountLocked 
} from '@/lib/security/auth-helpers';

export async function POST(request: Request) {
  const { email, password } = await request.json();
  
  // Check if locked
  if (isAccountLocked(email)) {
    return Response.json(
      { error: 'Account locked. Try again later.' },
      { status: 429 }
    );
  }
  
  // Try to authenticate...
  const success = await authenticate(email, password);
  
  if (!success) {
    const { locked, remainingAttempts, lockedUntil } = recordFailedLogin(email);
    
    if (locked) {
      return Response.json({
        error: `Account locked until ${lockedUntil?.toISOString()}`,
      }, { status: 429 });
    }
    
    return Response.json({
      error: `Invalid credentials. ${remainingAttempts} attempts remaining.`,
    }, { status: 401 });
  }
  
  // Clear on success
  clearFailedLogins(email);
  
  return Response.json({ success: true });
}
```

---

## Best Practices

### 1. üîë Qu·∫£n L√Ω Secrets

**‚úÖ N√äN:**
- S·ª≠ d·ª•ng environment variables
- Rotate secrets ƒë·ªãnh k·ª≥
- Kh√°c bi·ªát secrets gi·ªØa c√°c m√¥i tr∆∞·ªùng
- S·ª≠ d·ª•ng secret management tools (AWS Secrets Manager, Vercel, etc.)

**‚ùå KH√îNG N√äN:**
- Hard-code secrets trong code
- Commit `.env` files
- Share secrets qua email/chat
- D√πng chung secrets gi·ªØa dev v√† prod

### 2. üîê Password Security

**‚úÖ N√äN:**
- Y√™u c·∫ßu password >= 8 k√Ω t·ª±
- K·∫øt h·ª£p ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë, k√Ω t·ª± ƒë·∫∑c bi·ªát
- S·ª≠ d·ª•ng bcrypt ho·∫∑c PBKDF2 ƒë·ªÉ hash
- Implement account lockout
- Cho ph√©p password reset

**‚ùå KH√îNG N√äN:**
- L∆∞u password plain text
- G·ª≠i password qua email
- Log passwords
- D√πng MD5 ho·∫∑c SHA1 ƒë·ªÉ hash

### 3. üõ°Ô∏è Input Validation

**‚úÖ N√äN:**
- Validate tr√™n c·∫£ client V√Ä server
- Whitelist input (cho ph√©p nh·ªØng g√¨ an to√†n)
- Sanitize HTML output
- Validate file uploads (type, size)
- Limit input length

**‚ùå KH√îNG N√äN:**
- Trust client-side validation
- Blacklist patterns only
- Allow arbitrary HTML
- Skip validation cho "admin" users

### 4. üîí Session Management

**‚úÖ N√äN:**
- Use HttpOnly cookies
- Set SameSite=Strict/Lax
- Implement session timeout
- Regenerate session ID after login
- Use secure flag in production

**‚ùå KH√îNG N√äN:**
- Store session data in localStorage
- Use predictable session IDs
- Long-lived sessions
- Share sessions across domains

### 5. üåê API Security

**‚úÖ N√äN:**
- Implement rate limiting
- Validate all inputs
- Use HTTPS only
- Return proper error codes
- Log security events

**‚ùå KH√îNG N√äN:**
- Expose internal errors
- Allow unlimited requests
- Use GET for mutations
- Reveal system information

### 6. üìä Logging & Monitoring

**‚úÖ N√äN:**
- Log authentication events
- Log authorization failures
- Monitor suspicious patterns
- Set up alerts
- Regular security audits

**‚ùå KH√îNG N√äN:**
- Log sensitive data (passwords, tokens)
- Ignore error logs
- Store logs indefinitely
- Share logs publicly

---

## Checklist B·∫£o M·∫≠t

### Development

- [ ] `.env.local` kh√¥ng ƒë∆∞·ª£c commit
- [ ] T·∫•t c·∫£ secrets ƒë∆∞·ª£c set trong environment
- [ ] TypeScript errors = 0
- [ ] ESLint warnings ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
- [ ] Input validation cho t·∫•t c·∫£ forms
- [ ] CSRF protection cho mutations
- [ ] Rate limiting cho sensitive endpoints
- [ ] XSS protection (sanitize output)
- [ ] SQL injection protection (use parameterized queries)

### Pre-Production

- [ ] Security headers ƒë√£ ƒë∆∞·ª£c config
- [ ] HTTPS ƒë∆∞·ª£c enforce
- [ ] RLS policies ƒë√£ ƒë∆∞·ª£c test
- [ ] Rate limits ƒë√£ ƒë∆∞·ª£c test
- [ ] Error messages kh√¥ng leak info
- [ ] Logging ƒë∆∞·ª£c setup
- [ ] Monitoring ƒë∆∞·ª£c setup
- [ ] Backup strategy ƒë∆∞·ª£c plan

### Production

- [ ] Secrets rotation schedule
- [ ] Regular security audits
- [ ] Dependency updates (npm audit)
- [ ] Penetration testing
- [ ] Incident response plan
- [ ] User data encryption
- [ ] GDPR/Privacy compliance
- [ ] DDoS protection (Cloudflare, AWS Shield)

---

## X·ª≠ L√Ω S·ª± C·ªë

### 1. Ph√°t Hi·ªán Brute Force Attack

**D·∫•u hi·ªáu:**
- Nhi·ªÅu failed login attempts t·ª´ c√πng IP
- Rate limit errors tƒÉng ƒë·ªôt bi·∫øn

**H√†nh ƒë·ªông:**
```typescript
// Check logs
console.log(loginAttempts);

// Block IP t·∫°m th·ªùi (implement IP blacklist)
const blockedIPs = new Set<string>();

// TƒÉng lockout duration
authRateLimiter.interval = 60 * 60 * 1000; // 1 hour
```

### 2. Ph√°t Hi·ªán XSS Attempt

**D·∫•u hi·ªáu:**
- Input ch·ª©a `<script>`, `javascript:`, `onerror=`
- Suspicious query parameters

**H√†nh ƒë·ªông:**
```typescript
import { detectXss } from '@/lib/security/validation';

if (detectXss(userInput)) {
  logSecurityEvent('xss_attempt', { input: userInput });
  return Response.json({ error: 'Invalid input' }, { status: 400 });
}
```

### 3. Ph√°t Hi·ªán CSRF Attack

**D·∫•u hi·ªáu:**
- Missing CSRF token
- Invalid CSRF token
- Requests t·ª´ unknown origins

**H√†nh ƒë·ªông:**
```typescript
if (!await verifyCsrfToken(token)) {
  logSecurityEvent('csrf_violation', { 
    token, 
    origin: request.headers.get('origin') 
  });
  return Response.json({ error: 'Forbidden' }, { status: 403 });
}
```

### 4. Data Breach Response

**Ngay l·∫≠p t·ª©c:**
1. X√°c ƒë·ªãnh ph·∫°m vi breach
2. Isolate affected systems
3. Reset t·∫•t c·∫£ secrets
4. Force logout all users
5. Notify affected users
6. Report theo lu·∫≠t (GDPR: 72h)

**Sau ƒë√≥:**
1. Root cause analysis
2. Fix vulnerabilities
3. Update security measures
4. Train team
5. Document incident

---

## C√¥ng C·ª• B·∫£o M·∫≠t

### 1. Scanning Tools

```bash
# Dependency vulnerabilities
npm audit
npm audit fix

# Security scan
npm install -g snyk
snyk test

# OWASP ZAP (penetration testing)
# https://www.zaproxy.org/
```

### 2. Monitoring Services

- **Sentry**: Error tracking & monitoring
- **LogRocket**: Session replay & debugging
- **Datadog**: Infrastructure monitoring
- **CloudFlare**: DDoS protection & WAF

### 3. Testing

```typescript
// Example security test
describe('Security Tests', () => {
  it('should block XSS attempts', async () => {
    const xssPayload = '<script>alert("xss")</script>';
    const response = await fetch('/api/submit', {
      method: 'POST',
      body: JSON.stringify({ content: xssPayload }),
    });
    expect(response.status).toBe(400);
  });
  
  it('should enforce rate limiting', async () => {
    // Make 10 rapid requests
    const requests = Array(10).fill(null).map(() => 
      fetch('/api/login', { method: 'POST' })
    );
    const responses = await Promise.all(requests);
    const rateLimited = responses.some(r => r.status === 429);
    expect(rateLimited).toBe(true);
  });
});
```

---

## T√†i Li·ªáu Tham Kh·∫£o

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js Security](https://nextjs.org/docs/app/building-your-application/configuring/security)
- [Supabase Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Web Security Cheat Sheet](https://cheatsheetseries.owasp.org/)

---

## Li√™n H·ªá

N·∫øu ph√°t hi·ªán security vulnerability:
- **KH√îNG** t·∫°o public issue
- Email: security@yourdomain.com
- S·ª≠ d·ª•ng responsible disclosure

---

**L∆∞u √Ω:** B·∫£o m·∫≠t l√† m·ªôt qu√° tr√¨nh li√™n t·ª•c, kh√¥ng ph·∫£i l√† m·ªôt tr·∫°ng th√°i. Lu√¥n c·∫≠p nh·∫≠t v√† c·∫£i thi·ªán!

